"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const ora_1 = __importDefault(require("ora"));
const chalk_1 = __importDefault(require("chalk"));
const path_1 = require("path");
const inquirer_1 = require("inquirer");
const create_package_1 = __importDefault(require("../commands/create-package"));
const utils_1 = require("../utils");
//  Command:
//    create-package [name]
//
//  Steps:
//    1. validate project location
//    2. ask for the package name if it wasn't passed as argument and validate
//    3. ask for the package namespace if it wasn't passed as argument
//    4. create package
exports.default = async ({ name, namespace, prompt: promptUser, }) => {
    name = name || process.env.FRONTITY_NAME;
    if (!promptUser && !name) {
        utils_1.errorLogger(new Error("You need to provide the name for the project"));
    }
    // Init options
    const options = {};
    // Validate project location
    options.projectPath = process.cwd();
    if (!(await utils_1.isFrontityProjectRoot(options.projectPath))) {
        utils_1.errorLogger(new Error("You must execute this command in the root folder of a Frontity project."));
    }
    // Ask for the package name if it wasn't passed as argument and validate
    if (!name) {
        const questions = [
            {
                name: "name",
                type: "input",
                message: "Enter a name for the package:",
                default: "my-frontity-package",
            },
        ];
        const answers = await inquirer_1.prompt(questions);
        options.name = answers.name;
    }
    else {
        options.name = name;
    }
    if (!utils_1.isThemeNameValid(options.name)) {
        utils_1.errorLogger(new Error("The name of the package is not a valid npm package name."));
    }
    // 2.1 set the package path
    options.packagePath = path_1.normalize(`packages/${options.name.replace(/(?:@.+\/)/i, "")}`);
    // 3. ask for the package namespace if it wasn't passed as argument
    if (!namespace) {
        const questions = [
            {
                name: "namespace",
                type: "input",
                message: "Enter the namespace of the package:",
                default: "theme",
            },
        ];
        const answers = await inquirer_1.prompt(questions);
        options.namespace = answers.namespace;
    }
    else {
        options.namespace = namespace;
    }
    try {
        // 4. get the emitter for `create-package`
        const emitter = create_package_1.default(options);
        emitter.on("message", (message, action) => {
            if (action)
                ora_1.default.promise(action, message);
            else
                utils_1.log(message);
        });
        // 5. Actually create the package
        await emitter;
    }
    catch (error) {
        utils_1.errorLogger(error);
    }
    utils_1.log(chalk_1.default.bold(`\nNew package "${options.name}" created.\n`));
};
